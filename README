* 基本情報
- これは、自分用に改造したChatonです。
- Chatonについての基本情報は、以下を見てください。
-- README.orig (Chaton本来のREADME)
-- http://practical-scheme.net/chaton/
- この改造の元になったChatonのバージョンは、以下の通りです。
-- http://chaton.svn.sourceforge.net/viewvc/chaton/Chaton/trunk/
   の、 revision 154
- この改造自体は、以下のURLに置かれます。
-- https://github.com/ayamada/chaton-custom-tir


* 主な変更内容
- 設定可能項目の追加(詳細は後述)
- conf内でScheme式(string-appendとか)が書けるようになった(evalするだけ)
-- ただし、定義構文の値部分のみ。トップレベルにdefineとかは書けない
-- conf内のトップレベルに(use hoge)と書くと、モジュールのuseが可能
-- ※注意点：text.html-liteを使ってhtmlを埋め込む際には、必ず、
             text.treeのtree->stringを使って文字列化する事
- Read Archve の「本日のログ」の内容の厳密化/可視化/リダイレクトでなくする
- ログや発言のタイムスタンプを、GMTで扱うかlocaltimeで扱うかをconfで選択可能に
- 組み込みのログ検索機能
-- basic認証等をかけた為に、 search.html による外部の検索機能が
   使えなくなってしまった為の代用品
-- 単純な線形検索なので、ログが増えるにつれ重くなる
- w3mや携帯端末等の、comet制御ができない/不向きなブラウザの為の簡易クライアント
- youtubeサムネイルをiframe版に
- 一部の見た目にのみ関わる調整
- その他微細な変更


* 追加された設定項目と、そのデフォルト値
- (dont-expand-url #f)
-- 画像、youtube、ニコ動のurlを展開するかどうか
- (extra-css "")
-- chaton.cssの末尾に追加される
- (use-localtime #f)
-- 日時をGMTで扱うかサーバのlocaltimeで扱うか
- (timestamp-omit-interval (* 4 60))
-- 日時を省略する間隔を秒数で指定
- (dont-show-connect-num #f)
-- 現在cometサーバに接続している人数を表示するか否か
- (use-internal-search #f)
-- 検索機能にchaton-searchを使うか、search.html(google検索)を使うか
- (use-chaton-mobile #f)
-- chaton-mobileの使用の有無
- (dont-use-badge #f)
-- badge.htmlおよびchaton-badgeの使用の有無
- (extra-menu-html-list '())
-- メニュー部分に追加したいhtmlをlistで入れる(複数ok)
- (room-html "")
-- chaton-entryに埋め込むhtml
-- room-description は、rss等にも入ってしまう「chat部屋自体の説明文」なので、
   html等を入れづらい為、別項目を用意した


* TODO
** やる
- chaton-browserのアイコンとタイトルを、chaton-entry同様に、右に移動
- chaton-mobileの作成
- loose-loginが#fの時に、session expiredが出た後にリロードしても直らない問題を
  どうにかする
-- 再現手順: chatonを開いたままブラウザを再起動する
--- ブラウザ側は古いセッションを維持しているのに、サーバ側がexpireさせているのが原因？？？
--- もしかしたら、原因が二通りあるかもしれない。一つは上の通りで、もう一つは、cometサーバが、何らかの原因で長時間接続しているクライアントのセッションのtimestampが更新されてない時がある？
** あとまわし
- htaccessいじって、indexをmにし、モバイルモードかどうかの切り替えは
  cookieで制御する(デフォルトはモバイルモード)
-- これもconfファイルを見て、挙動を変更する必要あり
--- 項目名を決める事
- 過去ログの逆順表示
-- でもMobile modeの実装状況によっては不要かも。あとで判断する
- githubに保存する際に、オリジナルと改変部分とでブランチ変更するの忘れてたので、このままではrebaseできない。なんとかすること
-- このままでもrebaseできるなら不要。できる？
--- オリジナルの方を、別ブランチ名で追加すればいいだけ？
** やらない
- client/chaton/client.scm の chaton-permalink の元になる日時の扱いをどうするか
-- client/chaton/client.scm は要するに、
   外部のtwitterブリッジ等から利用される手続きで、
   サーバにある chaton.scm とは完全に分離している。
   (Chaton本体とは別サーバ上でプロセスが動いたりする可能性がある)
   という事は、confの設定で、日付をGMTで扱うかlocaltimeで扱うかを
   変更できるようにしたにも関わらず、この部分はまた別途に設定する必要がある。
--- 解決案として、「make-permalink と chaton-permalink のみ、常に
    日付をGMTとして扱う」というのを考えたが、これだと、anchor部分はいいが、
    URL部分に日付が入るところで、わざわざlocaltimeにデグレードさせた意味が
    なくなってしまう(localtimeでの日単位でのログ分割じゃなくなってしまう)。
    この問題を本質的に解決するには、URLにTZ情報を含める仕様にするぐらい？
-- 大変そうなので、放置する事にする。


* 改造方針
- 上流が更新された際にバージョンアップしやすいように、
  なるべく元ファイルの状態を温存する
- 上流へ還元できる形であるにこした事はないが、そこまではがんばらない


* その他のメモ
- 本体のバージョンが上がった際には、git rebaseでバージョンアップできるかも
  (できないかも)
- Chatonは、内部encodingがutf-8のGaucheでないと動きません。
  (少なくとも、最初に元にしたrevision 154では)
  いい機会なので、環境のutf-8化をしてしまいましょう。
- Chatonのcomet serverを、特定ipだけlistenさせる事はちょっと改造すればできる。
  しかし、80番をlistenするようにするにはroot権限が必要になる為、かなり困難。
  (セキュリティを諦めてcomet serverのプロセスをrootで走らせるか、
   apache等の他のhttpdのように、80番をlistenしてから権限を落としたり等の
   工夫が必要になる)
  もしそれをやる場合は、djbのtcpserverに中継させる方針がいいと思う。
  (この方針であれば、もし必要なら、tcpserverのssl対応パッチを使って
   https対応にすらできるかもしれない(できないかもしれない)。
   tcpserverでsslをする場合は結構重くなるので問題かもしれないが)
-- これをやる場合、chaton-entry等も、comet serverが出力してしまうのが良い。
   その場合は、tcpcgiのコードを流用できる。
--- ただ、tcpcgiはbasic認証が未実装だった気がするので、そこは頑張る必要が





