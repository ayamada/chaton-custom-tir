* 基本情報
- これは、自分用に改造したChatonです。
- Chatonについての基本情報は、以下を見てください。
-- README.orig (Chaton本来のREADME)
-- http://practical-scheme.net/chaton/
- この改造の元になったChatonのバージョンは、以下の通りです。
-- http://chaton.svn.sourceforge.net/viewvc/chaton/Chaton/trunk/
   の、 revision 154
- この改造自体は、以下のURLに置かれます。
-- https://github.com/ayamada/chaton-custom-tir


* 主な変更内容
- Read Archve の「本日のログ」の内容の厳密化/可視化
- ログや発言のタイムスタンプを、GMTで扱うかlocaltimeで扱うかをconfで選択可能に
- 組み込みのログ検索機能
-- basic認証等をかけた為に、 search.html による外部の検索機能が
   使えなくなってしまった為の代用品
-- 単純な線形検索なので、ログが増えるにつれ重くなる
- w3mや携帯端末等の、comet制御ができない/不向きなブラウザの為の簡易クライアント
- 一部の見た目にのみ関わる調整
- その他微細な変更


* 追加されたファイル
- README.orig 元々のChatonのREADMEはここに退避
- chaton-search 前述の、組み込みのログ検索cgi
- chaton-mobile 前述の、JavaScript非対応ブラウザの為の簡易クライアントcgi


* 追加された設定項目
あとでかく


* TODO
** やる
- confファイルで以下を設定可能に
-- GMTベースかlocaltimeベースか
-- 連続投稿の表示時の日付省略機能の期間を任意設定可能に
-- connectの数値の表示/非表示
-- 検索を search.html にするか chaton-search にするか
-- youtube, ニコニコ動画、画像ファイルのサムネイル表示の有効/無効
--- この設定は conf/appearance.conf に入れる
- chaton-mobileの作成
- chaton-searchの検索対象は、行単位ではなく、日単位とする？
-- チェックボックスか何かで動作を指定できるようにする
- sample.confがなるべく元のchaton互換になるように対応する
-- 現在TODOに入っている、新しい設定項目を、 conf/* に入れるべきものはふりわけましょう
-- tool link回りをconfに追い出す
-- css個別設定もconfに追い出す
-- 他にも、css回りの設定をいじった部分があるなら、元に戻すべきか調査する事
-- conf/* に追い出すか、 *.conf に追い出すかは要検討
-- chaton-entryの、元々tools等のリンクがあった場所に、*.conf設定で、
   説明文を入れられるようにする(仮)
--- 現状の room-description での説明文はrss等にも入ってしまう、
    「chat部屋自体の詳細のテキスト」なので、
    html等は入れづらい為、専用の項目を作りたい。
    ついでなので、そこに元のtoolsを追い出す
--- Read Archive 等のリンクはとりあえず今のところは、この扱いにはしない
- build-site実行時に、sとsearch.htmlは両方生成して、confを見て、不要な方を削除するようにしましょう(動的変更時に古いファイルが残る対策を兼ねている)
- 今日本語になっている部分の英語化
- loose-loginが#fの時に、session expiredが出た後にリロードしても直らない問題を
  どうにかする
** あとまわし
- chaton-searchの英語化
- htaccessいじって、indexをmにし、モバイルモードかどうかの切り替えは
  cookieで制御する(デフォルトはモバイルモード)
-- これもconfファイルを見て、挙動を変更する必要あり
- 部屋別にbasic認証をかけたりかけなかったりできるような、htaccess制御
-- どういう風に実現するか仕様を考える事
- chaton-searchでfindを使わないように直す
** やらない
- client/chaton/client.scm の chaton-permalink の元になる日時の扱いをどうするか
-- 要は、 chaton.scm の make-permalink は、上の改造でlocaltimeで扱うように
   したのに、 client/chaton/client.scm の chaton-permalink は、
   GMTのままでいいのか、という話。
--- 先に結論だけ書いておくと、
    「自分は client/chaton/client.scm は使わないので、GMTのまま放置」。
-- client/chaton/client.scm の chaton-permalink は要するに、
   外部のtwitterブリッジ等から利用される手続きで、
   サーバにある chaton.scm とは完全に分離している。
   例えば別サーバ上でプロセスが動いたりする可能性があるので、
   client/chaton/client.scm は、安易に (use chaton) できない。
   という事は、chaton.scmだけいじれば、日付をGMTで扱うかlocaltimeで扱うかを
   変更できるようにしたにも関わらず、この部分はまた別途に設定する必要がある、
   という事。
   これについて色々考えたが、とりあえず、
   「このカスタマイズの利用者は自分のみの前提」
   「自分は今のところ client/chaton/client.scm を使う予定はなし]
   という二点より、前述の結論とした。
--- 解決案として、「make-permalink と chaton-permalink のみ、常に
    日付をGMTとして扱う」というのを考えたが、これだと、anchor部分はいいが、
    URL部分に日付が入るところで、わざわざlocaltimeにデグレードさせた意味が
    なくなってしまう(localtimeでの日単位でのログ分割じゃなくなってしまう)。
    この問題を本質的に解決するには、URLにTZ情報を含める仕様にするぐらい？
- archiveは、今日の日付のログ表示時のみno-cache系のヘッダを出力する
-- 判定条件は、シンボリックリンクか否かだけでok
-- よく考えたら、ログ自体は変化しなくても、右のログ一覧は常に変化する可能性が
   あるので、常にno-cache系ヘッダを出力する意味があり、やらない事に


* 改造方針
- 上流が更新された際にバージョンアップしやすいように、
  なるべく元ファイルの状態を温存する
- 上流へ還元できる形であるにこした事はないが、そこまではがんばらない
-- 拡張した部分では日本語を使ってok


* chaton-search, chaton-mobileのみを導入する際の注意点
- build-site と htaccess も持っていく/変更する必要があります
-- build-site は、make install時にcharon-search等を反映する為に必要
-- htaccess は、新たに追加になったファイルをcgi動作させる為に必要
- 各ファイルの、日付判定厳密化の為の有効無効フラグを書き換える必要があるかも
-- 詳細はあとでまとめる
- (optional) chaton-entryを書き換える
  (chaton-search, chaton-mobileへのリンクを入れる)


* その他のメモ
- 本体のバージョンが上がった際には、git rebaseでバージョンアップできるかも
  (できないかも)
- Chatonは、内部encodingがutf-8のGaucheでないと動きません。
  (少なくとも、最初に元にしたrevision 154では)
  いい機会なので、環境のutf-8化をしてしまいましょう。
- Chatonのcomet serverを、特定ipだけlistenさせる事はちょっと改造すればできる。
  しかし、80番をlistenするようにするにはroot権限が必要になる為、かなり困難。
  (セキュリティを諦めてcomet serverのプロセスをrootで走らせるか、
   apache等の他のhttpdのように、80番をlistenしてから権限を落としたり等の
   工夫が必要になる)
  もしそれをやる場合は、djbのtcpserverに中継させる方針がいいと思う。
  (この方針であれば、もし必要なら、tcpserverのssl対応パッチを使って
   https対応にすらできるかもしれない(できないかもしれない)。
   tcpserverでsslをする場合は結構重くなるので気軽ではないが)
-- これをやる場合、chaton-entry等も、comet serverが出力してしまうのが良い。
   その場合は、tcpcgiのコードを流用できる。
--- ただ、tcpcgiはbasic認証が未実装だった気がするので、そこは頑張る必要が





